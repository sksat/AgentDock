# AgentDock - è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## æ¦‚è¦

AgentDock ã¯ã€Claude Code CLI ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒƒãƒ UI ã‹ã‚‰æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚å˜ãªã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€**plan ãƒ¢ãƒ¼ãƒ‰ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€é¸æŠè‚¢ã€å·®åˆ†ææ¡ˆãªã©ã‚’å°‚ç”¨ UI ã§è¡¨ç¤º**ã—ã¾ã™ã€‚

## è¦ä»¶

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript + shadcn/ui
- **èªè¨¼**: ä¸è¦ï¼ˆè‡ªåˆ†å°‚ç”¨ï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–**: å¿…è¦ï¼ˆClaude Code ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
- **ãƒªãƒƒãƒUI**: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›ã ã‘ã§ãªãã€æ§‹é€ åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€è³ªå•ã€å·®åˆ†ï¼‰ã‚’å°‚ç”¨ UI ã§è¡¨ç¤º
- **Claude Max äº’æ›**: å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸæ–¹æ³•ã®ã¿ä½¿ç”¨

## èƒŒæ™¯çŸ¥è­˜

### Claude Code CLI Headless Mode

Claude Max ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸæ–¹æ³•ã€‚

```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
claude -p "prompt" --output-format stream-json

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
claude -p "follow-up" --continue
claude -p "specific session" --resume <session_id>

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ MCP ãƒ„ãƒ¼ãƒ«ã«å§”è­²
claude -p "prompt" --permission-prompt-tool mcp__bridge__permission_prompt
```

### --permission-prompt-tool ã‚ªãƒ—ã‚·ãƒ§ãƒ³

ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ MCP ãƒ„ãƒ¼ãƒ«ã«å§”è­²ã™ã‚‹å…¬å¼æ©Ÿèƒ½ã€‚

**å‹•ä½œãƒ¡ã‚«ãƒ‹ã‚ºãƒ ** (3å±¤ãƒã‚§ãƒƒã‚¯):
1. `--allowedTools` / `--disallowedTools` ã§äº‹å‰å®šç¾©ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
2. ãƒ«ãƒ¼ãƒ«ãŒãƒãƒƒãƒã™ã‚Œã°å³åº§ã«è¨±å¯/æ‹’å¦
3. ãƒ«ãƒ¼ãƒ«ãªã—ãªã‚‰ MCP ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—

**MCP ãƒ„ãƒ¼ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
```json
// è¨±å¯
{"behavior": "allow", "updatedInput": {...}}

// æ‹’å¦
{"behavior": "deny", "message": "ç†ç”±"}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ `~/.claude/sessions/` ã«è‡ªå‹•ä¿å­˜
- `--resume <session_id>` ã§ç‰¹å®šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹
- `--continue` ã§æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
- stream-json å‡ºåŠ›ã« `session_id` ãŒå«ã¾ã‚Œã‚‹

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Server (Node.js)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Hono + WebSocket                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚              Session Manager                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Session #1   â”‚  â”‚   Session #2   â”‚  ...     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚claude CLI  â”‚ â”‚  â”‚ â”‚claude CLI  â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚(subprocess)â”‚ â”‚  â”‚ â”‚(subprocess)â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚stream-json â”‚ â”‚  â”‚ â”‚stream-json â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚         BrowserSessionManager (Playwright)        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ + CDP Screencast ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚      MCP Server (Permission + Browser Tools)      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    permission_prompt / browser_* â—„â”€â”€â–º WebSocket   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ WebSocket
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Sidebar    â”‚  â”‚            Main Area                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚Session1â”‚  â”‚  â”‚  â”‚   MessageStream / BrowserView  â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚Session2â”‚  â”‚  â”‚  â”‚  â”‚ [Text Output]            â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  [+]   â”‚  â”‚  â”‚  â”‚  â”‚ [Permission Request UI]  â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â”‚  Allow / Deny / Modify   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚ [BrowserView]            â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚  Canvas + URL bar        â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚        Input Area              â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ WebSocket â†’ ã‚µãƒ¼ãƒãƒ¼
   - ã‚µãƒ¼ãƒãƒ¼: `claude -p "prompt" --resume <session_id> --output-format stream-json --permission-prompt-tool mcp__bridge__permission_prompt`

2. **Claude å‡ºåŠ›**
   - claude CLI (stream-json) â†’ ã‚µãƒ¼ãƒãƒ¼ã§ãƒ‘ãƒ¼ã‚¹ â†’ WebSocket â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI

3. **ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚**
   - claude CLI â†’ MCP Server (permission_prompt ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—)
   - MCP Server â†’ WebSocket â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­” â†’ WebSocket â†’ MCP Server â†’ allow/deny ã‚’è¿”ã™
   - claude CLI ãŒå‡¦ç†ã‚’ç¶™ç¶š

4. **AskUserQuestion**
   - AskUserQuestion ã¯ `--allowedTools` ã«å«ã‚ã‚‹ã“ã¨ã§è‡ªå‹•è¨±å¯
   - ã¾ãŸã¯ MCP Server ã§ç‰¹åˆ¥å‡¦ç†ã—ã¦ WebSocket ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è»¢é€

5. **ãƒ–ãƒ©ã‚¦ã‚¶ç”»é¢ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**
   - BrowserSessionManager â†’ CDP Screencast â†’ Base64 JPEG â†’ WebSocket â†’ BrowserView (Canvas)
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ (click/key/scroll) â†’ WebSocket â†’ Playwright page æ“ä½œ

---

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
agent-dock/
â”œâ”€â”€ package.json              # Monorepo root
â”œâ”€â”€ pnpm-workspace.yaml       # pnpm workspaces è¨­å®š
â”œâ”€â”€ mcp-config.json           # MCP ã‚µãƒ¼ãƒãƒ¼è¨­å®š
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ server/               # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts     # Hono + WebSocket
â”‚   â”‚   â”‚   â”œâ”€â”€ session-manager.ts  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ claude-runner.ts    # claude CLI å®Ÿè¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ runner-manager.ts   # Runner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ stream-parser.ts    # stream-json ãƒ‘ãƒ¼ã‚µãƒ¼
â”‚   â”‚   â”‚   â””â”€â”€ browser-session-manager.ts  # ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp-server/           # MCP ã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ + ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # MCP ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ permission-handler.ts  # permission_prompt ãƒ„ãƒ¼ãƒ«
â”‚   â”‚   â”‚   â””â”€â”€ playwright-handler.ts  # browser_* ãƒ„ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ client/               # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SessionTab.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageStream.tsx     # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PermissionRequest.tsx # ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ UI
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AskUserQuestion.tsx   # è³ªå• UI
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DiffView.tsx          # å·®åˆ†è¡¨ç¤º
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InputArea.tsx         # å…¥åŠ›ã‚¨ãƒªã‚¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BrowserView.tsx       # ãƒ–ãƒ©ã‚¦ã‚¶ãƒ“ãƒ¥ãƒ¼
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useSession.ts
â”‚   â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ vite.config.ts
â”‚   â”‚
â”‚   â””â”€â”€ shared/               # å…±æœ‰å‹å®šç¾©
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â””â”€â”€ index.ts      # WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ DESIGN.md                 # ã“ã®è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â””â”€â”€ README.md
```

---

## æŠ€è¡“é¸å®š

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Node.js | 22.x / 24.x |
| è¨€èª | TypeScript | 5.9.x |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | React | 19.2.x |
| UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | shadcn/ui | (Tailwind v4å¯¾å¿œ) |
| CSS | Tailwind CSS | 4.x |
| å·®åˆ†è¡¨ç¤º | react-diff-viewer-continued | 3.4.x |
| é€šä¿¡ | ws | 8.18.x |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Hono | 4.11.x |
| Claude å®Ÿè¡Œ | `claude` CLI | (subprocess, stream-json) |
| MCP Server | @modelcontextprotocol/sdk | 1.12.x |
| ãƒ“ãƒ«ãƒ‰ (client) | Vite | 7.x |
| ãƒ“ãƒ«ãƒ‰ (server) | tsc | - |
| ãƒ¢ãƒãƒ¬ãƒ | pnpm workspaces | - |
| ãƒ†ã‚¹ãƒˆ | vitest | 3.x |
| ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ– | Playwright | (via @anthropic/playwright-mcp) |
| ç”»é¢ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° | CDP Screencast | (via @anthropic/browser-streamer) |

---

## WebSocket ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
type ClientMessage =
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  | { type: 'create_session'; name?: string; workingDir?: string }
  | { type: 'attach_session'; sessionId: string }
  | { type: 'detach_session'; sessionId: string }
  | { type: 'delete_session'; sessionId: string }
  | { type: 'rename_session'; sessionId: string; name: string }
  | { type: 'list_sessions' }
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
  | { type: 'user_message'; sessionId: string; content: string }
  | { type: 'interrupt'; sessionId: string }
  // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å¿œç­”
  | { type: 'permission_response'; sessionId: string; requestId: string;
      response: { behavior: 'allow'; updatedInput: any } | { behavior: 'deny'; message: string } }
  // AskUserQuestion å¿œç­”
  | { type: 'question_response'; sessionId: string; requestId: string;
      answers: Record<string, string> }
  // ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ
  | { type: 'start_screencast'; sessionId: string }
  | { type: 'stop_screencast'; sessionId: string }
  | { type: 'user_browser_click'; sessionId: string; x: number; y: number }
  | { type: 'user_browser_key_press'; sessionId: string; key: string }
  | { type: 'user_browser_scroll'; sessionId: string; deltaX: number; deltaY: number }
  | { type: 'user_browser_navigate'; sessionId: string; url: string }
  | { type: 'user_browser_back'; sessionId: string }
  | { type: 'user_browser_forward'; sessionId: string }
  | { type: 'user_browser_refresh'; sessionId: string };

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
type ServerMessage =
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  | { type: 'session_created'; session: SessionInfo }
  | { type: 'session_attached'; sessionId: string; history: MessageItem[] }
  | { type: 'session_list'; sessions: SessionInfo[] }
  | { type: 'session_deleted'; sessionId: string }
  // Agent å‡ºåŠ›
  | { type: 'text_output'; sessionId: string; text: string }
  | { type: 'tool_use'; sessionId: string; toolName: string; toolUseId: string; input: any }
  | { type: 'tool_result'; sessionId: string; toolUseId: string; content: string; isError?: boolean }
  | { type: 'result'; sessionId: string; result: string }
  // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  | { type: 'permission_request'; sessionId: string; requestId: string;
      toolName: string; input: any }
  // AskUserQuestion
  | { type: 'ask_user_question'; sessionId: string; requestId: string;
      questions: Array<{ question: string; header: string;
                         options: Array<{ label: string; description: string }>;
                         multiSelect: boolean }> }
  // ãƒ–ãƒ©ã‚¦ã‚¶ç”»é¢
  | { type: 'screencast_frame'; sessionId: string; data: string; metadata: ScreencastMetadata }
  | { type: 'screencast_status'; sessionId: string; active: boolean; browserUrl?: string; browserTitle?: string }
  | { type: 'screencast_cursor'; sessionId: string; cursor: string }
  // ã‚¨ãƒ©ãƒ¼
  | { type: 'error'; sessionId?: string; message: string };

interface ScreencastMetadata {
  deviceWidth: number;
  deviceHeight: number;
  timestamp: number;
}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±

```typescript
interface SessionInfo {
  id: string;              // Bridge ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID
  name: string;            // è¡¨ç¤ºå
  createdAt: string;       // ä½œæˆæ—¥æ™‚
  workingDir: string;      // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  status: SessionStatus;   // çŠ¶æ…‹
  claudeSessionId?: string; // Claude CLI ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID (--resume ç”¨)
}

type SessionStatus = 'running' | 'waiting_input' | 'waiting_permission' | 'idle';
```

---

## ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### ClaudeRunner (packages/server/src/claude-runner.ts)

Claude CLI ã‚’ subprocess ã¨ã—ã¦å®Ÿè¡Œã—ã€stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- `claude` CLI ã®èµ·å‹• (`spawn`)
- stream-json (NDJSON) å‡ºåŠ›ã®ãƒ‘ãƒ¼ã‚¹
- ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œ (`text`, `tool_use`, `tool_result`, `result`, `system`, `error`, `exit`)

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³:**
- `workingDir`: ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- `claudePath`: claude ã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ã‚¹
- `mcpConfigPath`: MCP è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
- `permissionToolName`: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«å

### RunnerManager (packages/server/src/runner-manager.ts)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã® ClaudeRunner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- ClaudeRunner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã¨ Runner ã®ç´ä»˜ã‘
- ã‚¤ãƒ™ãƒ³ãƒˆã®è»¢é€

### SessionManager (packages/server/src/session-manager.ts)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ/å‰Šé™¤/æ›´æ–°
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®ä¿æŒ
- Claude ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ç´ä»˜ã‘

### StreamJsonParser (packages/server/src/stream-parser.ts)

Claude CLI ã® stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€‚

**å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ:**
- `assistant`: ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã€ãƒ„ãƒ¼ãƒ«ä½¿ç”¨
- `user`: ãƒ„ãƒ¼ãƒ«çµæœ
- `result`: å‡¦ç†å®Œäº†
- `system`: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### BrowserSessionManager (packages/server/src/browser-session-manager.ts)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã—ã€CDP Screencast ã«ã‚ˆã‚‹ç”»é¢ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’æä¾›ã€‚

**è²¬å‹™:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- CDP Screencast ã§ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—ãƒ»è»¢é€
- `framenavigated` ã‚¤ãƒ™ãƒ³ãƒˆã§ URL/ã‚¿ã‚¤ãƒˆãƒ«åŒæœŸ

**ã‚¤ãƒ™ãƒ³ãƒˆ:** `frame`, `status`, `error`

### BrowserView (packages/client/src/components/BrowserView.tsx)

ãƒ–ãƒ©ã‚¦ã‚¶ç”»é¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ Canvas ã§è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

**æ©Ÿèƒ½:**
- Canvas ã«ã‚ˆã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒï¼‰
- ãƒ–ãƒ©ã‚¦ã‚¶ chrome UIï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼‰
- ç·¨é›†å¯èƒ½ãª URL ãƒãƒ¼ã€æˆ»ã‚‹/é€²ã‚€/ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
- ãƒã‚¦ã‚¹/ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã€ã‚«ãƒ¼ã‚½ãƒ«åŒæœŸ

---

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºç›¤ âœ…
1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–** âœ…
   - pnpm workspaces ã§ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ
   - TypeScript è¨­å®š
   - shared ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å‹å®šç¾©ã‚’å…±æœ‰

2. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤** âœ…
   - Hono ã‚µãƒ¼ãƒãƒ¼
   - WebSocket ã‚µãƒ¼ãƒãƒ¼ (ws)
   - åŸºæœ¬çš„ãªæ¥ç¶šç¢ºèª

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤** âœ…
   - Vite + React + TypeScript
   - WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (useWebSocket hook)

### Phase 2: Claude CLI çµ±åˆ ğŸš§
4. **Claude CLI å®Ÿè¡ŒåŸºç›¤** âœ…
   - child_process ã§ claude CLI ã‚’å®Ÿè¡Œ
   - stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹
   - NDJSON ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†

5. **MCP Server å®Ÿè£…** ğŸš§
   - @modelcontextprotocol/sdk ã§ã‚µãƒ¼ãƒãƒ¼ä½œæˆ
   - `permission_prompt` ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…
   - WebSocket ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨é€šä¿¡

6. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** â³
   - MessageStream: ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›è¡¨ç¤º
   - PermissionRequest: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨±å¯ UI
   - InputArea: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›

### Phase 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† â³
7. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - `--resume <session_id>` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®ä¿æŒ

8. **ã‚µã‚¤ãƒ‰ãƒãƒ¼ UI**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ/å‰Šé™¤/åå‰å¤‰æ›´

### Phase 4: ä»•ä¸Šã’ â³
9. **AskUserQuestion UI**
   - Claude ã‹ã‚‰ã®è³ªå•ã‚’é¸æŠè‚¢ UI ã§è¡¨ç¤º

10. **å·®åˆ†è¡¨ç¤º UI**
    - Write/Edit ãƒ„ãƒ¼ãƒ«ã®å·®åˆ†ã‚’ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
    - react-diff-viewer-continued ã§å®Ÿè£…

11. **UXæ”¹å–„**
    - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    - ä¸­æ–­æ©Ÿèƒ½ï¼ˆSIGINT é€ä¿¡ï¼‰

---

## æ¤œè¨¼æ–¹æ³•

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd packages/server && pnpm dev

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
cd packages/client && pnpm dev
```

http://localhost:5173 ã§ã‚¢ã‚¯ã‚»ã‚¹

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
pnpm -r test

# ç‰¹å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
cd packages/server && pnpm test
```

### å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒã§ãã‚‹
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹
- [ ] Claude ã‹ã‚‰ã®å¿œç­”ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆstream-jsonï¼‰
- [ ] ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ UI ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆMCP çµŒç”±ï¼‰
- [ ] ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨±å¯/æ‹’å¦ã§ãã‚‹
- [ ] AskUserQuestion ãŒé¸æŠè‚¢ UI ã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é¸æŠå¾Œã« Claude ãŒå‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹
- [ ] è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ï¼ˆ--resumeï¼‰
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦å†æ¥ç¶šã—ã¦ã‚‚å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ç”»é¢ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œã‚‹
- [ ] URL ãƒãƒ¼ã«ç¾åœ¨ã® URL/ã‚¿ã‚¤ãƒˆãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] URL ãƒãƒ¼ã‹ã‚‰ç›´æ¥ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã‚‹
- [ ] æˆ»ã‚‹/é€²ã‚€/ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«åæ˜ ã•ã‚Œã‚‹

---

## æ³¨æ„äº‹é …

### MCP Server ã®åˆ¶ç´„

- MCP ãƒ„ãƒ¼ãƒ«ã¯ **åŒæœŸçš„ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒãªã„**ï¼ˆPromise ã‚’è¿”ã›ã‚‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å¾…æ©Ÿã™ã‚‹é–“ã€Promise ã‚’ resolve ã›ãšã«å¾…æ©Ÿå¯èƒ½
- ãŸã ã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰ã«æ³¨æ„

### stream-json å‡ºåŠ›å½¢å¼

- NDJSON (Newline Delimited JSON) å½¢å¼
- å„è¡ŒãŒç‹¬ç«‹ã—ãŸ JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `type` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥ã‚’åˆ¤åˆ¥

### Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ°¸ç¶šæ€§

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ `~/.claude/sessions/` ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹
- `--resume <session_id>` ã§å†é–‹å¯èƒ½
- ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã®ã¿ç®¡ç†

### Claude Max ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

- `ANTHROPIC_API_KEY` ç’°å¢ƒå¤‰æ•°ãŒ **è¨­å®šã•ã‚Œã¦ã„ãªã„** ã“ã¨ã‚’ç¢ºèª
- Claude Max subscription ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- Anthropic ãŒå…¬å¼ã«è¨±å¯ã—ã¦ã„ã‚‹æ–¹æ³•ã®ã¿ä½¿ç”¨

---

## è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### Per-Session State Management

è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæ™‚ã«æ‰±ã†å ´åˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ« state ã§ã¯ãªã **Map ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«çŠ¶æ…‹ã‚’åˆ†é›¢**ã™ã‚‹ã€‚

**å•é¡Œ**: å˜ä¸€ã® state ã§ç®¡ç†ã™ã‚‹ã¨ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«çŠ¶æ…‹ãŒæ··ä¹±ã™ã‚‹ã€‚
- ä¾‹: Session A ã® PermissionRequest ãŒ Session B ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹

**è§£æ±ºç­–**: Map<sessionId, State> ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«åˆ†é›¢

```typescript
// Bad: å˜ä¸€ã® stateï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«æ··ä¹±ï¼‰
const [pendingQuestion, setPendingQuestion] = useState(null);

// Good: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«åˆ†é›¢
const [sessionPendingQuestion, setSessionPendingQuestion] = useState<Map<string, PendingQuestion>>(new Map());

// ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® state ã‚’ computed value ã¨ã—ã¦å–å¾—
const pendingQuestion = activeSessionId
  ? sessionPendingQuestion.get(activeSessionId)
  : null;
```

**é©ç”¨ç®‡æ‰€**:
- `pendingPermission`: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚
- `pendingQuestion`: AskUserQuestion è¦æ±‚
- `sessionMessages`: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´
- `sessionUsageInfo`: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡

### Real-time Status Broadcast

ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å¤‰æ›´ï¼ˆidle â†’ running ãªã©ï¼‰ã¯ã€**å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ**ã™ã‚‹ã€‚

**ç†ç”±**: è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã«çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹ãŸã‚ã€‚

```typescript
// ã‚µãƒ¼ãƒãƒ¼å´: çŠ¶æ…‹å¤‰æ›´æ™‚ã«å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸é€šçŸ¥
function broadcastStatusChange(sessionId: string, status: SessionStatus) {
  broadcastToAll({
    type: 'session_status_changed',
    sessionId,
    status,
  });
}
```

**æ³¨æ„**: `session_attached` ã®ã‚ˆã†ãªç‰¹å®šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ç•°ãªã‚Šã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã¯å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒçŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### Defensive Rendering for External Data

DB ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€**Guard clause ã§ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã‚’é˜²å¾¡**ã™ã‚‹ã€‚

**å•é¡Œ**: å¤ã„DBãƒ‡ãƒ¼ã‚¿ã‚„äºˆæœŸã›ã¬å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

**è§£æ±ºç­–**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†’é ­ã§ Guard clause ã‚’å…¥ã‚Œã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ UI ã‚’è¡¨ç¤º

```typescript
function QuestionMessage({ content }: { content: QuestionMessageContent }) {
  // Guard against invalid content
  if (!content || !Array.isArray(content.answers)) {
    return (
      <div data-testid="message-item">
        <span>AskUserQuestion</span>
        <span>User answered questions.</span>
      </div>
    );
  }

  // Normal rendering
  return content.answers.map(...);
}
```

**ãƒ†ã‚¹ãƒˆè¦ä»¶**: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯å …ç‰¢æ€§ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹

```typescript
describe('QuestionMessage robustness', () => {
  it('should not crash with null content', () => { ... });
  it('should not crash with undefined content', () => { ... });
  it('should not crash with legacy data structure', () => { ... });
});
```

### AgentDock çµ±åˆ MCP ãƒ„ãƒ¼ãƒ«ã®è‡ªå‹•è¨±å¯

AgentDock ãŒæä¾›ã™ã‚‹ MCP ãƒ„ãƒ¼ãƒ«ï¼ˆ`mcp__bridge__*`ï¼‰ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨±å¯ãªã—ã«è‡ªå‹•å®Ÿè¡Œ**ã•ã‚Œã‚‹ã€‚

**ç†ç”±**:
- AgentDock çµ±åˆ MCP ãƒ„ãƒ¼ãƒ«ã¯ AgentDock è‡ªèº«ãŒæä¾›ã—ã€UI ã¨å¯†æ¥ã«é€£æºã™ã‚‹ãŸã‚ä¿¡é ¼ã§ãã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã€ãƒãƒ¼ãƒˆç›£è¦–ãªã©ã€é »ç¹ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§æ¯å›è¨±å¯ã‚’æ±‚ã‚ã‚‹ã®ã¯ UX ãŒæ‚ªã„
- å¤–éƒ¨ MCP ãƒ„ãƒ¼ãƒ«ï¼ˆ`mcp__plugin_*`ï¼‰ã¨ã¯æ˜ç¢ºã«åŒºåˆ¥ã•ã‚Œã‚‹

**è‡ªå‹•è¨±å¯ã•ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«**:
1. **AgentDock çµ±åˆ MCP ãƒ„ãƒ¼ãƒ«** (`mcp__bridge__*`)
   - `mcp__bridge__browser_*`: ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œãƒ„ãƒ¼ãƒ«
   - `mcp__bridge__port_monitor`: ãƒãƒ¼ãƒˆç›£è¦–ãƒ„ãƒ¼ãƒ«
   - `mcp__bridge__permission_prompt`: å†…éƒ¨ä½¿ç”¨ï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å‡¦ç†ï¼‰
   - ä»Šå¾Œè¿½åŠ ã•ã‚Œã‚‹ `mcp__bridge__*` ãƒ„ãƒ¼ãƒ«ã‚‚è‡ªå‹•çš„ã«è¨±å¯ã•ã‚Œã‚‹

2. **AskUserQuestion**: UI ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…é ˆãªãŸã‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãªã—ï¼‰

**è‡ªå‹•è¨±å¯ã•ã‚Œãªã„ãƒ„ãƒ¼ãƒ«**:
- **å¤–éƒ¨ MCP ãƒ„ãƒ¼ãƒ«** (`mcp__plugin_*`): å¤–éƒ¨ MCP ã‚µãƒ¼ãƒãƒ¼ãŒæä¾›ã™ã‚‹ãƒ„ãƒ¼ãƒ«
- **Claude Code æ¨™æº–ãƒ„ãƒ¼ãƒ«** (`Bash`, `Write`, `Edit` ãªã©): ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚„ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã¯è¨±å¯ãŒå¿…è¦

**å®Ÿè£…**:
```typescript
// packages/server/src/server.ts

// AgentDock çµ±åˆ MCP ãƒ„ãƒ¼ãƒ«ã®åˆ¤å®š
function isAgentDockTool(toolName: string): boolean {
  return /^mcp__bridge__/.test(toolName);
}

// è‡ªå‹•è¨±å¯ãƒ„ãƒ¼ãƒ«ã®åˆ¤å®š
function isAutoAllowedTool(toolName: string): boolean {
  if (isAgentDockTool(toolName)) return true;
  if (toolName === 'AskUserQuestion') return true;
  return false;
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®**:
- AgentDock çµ±åˆãƒ„ãƒ¼ãƒ«ã¯ã€AgentDock é–‹ç™ºè€…ãŒå®‰å…¨æ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã«é™å®š
- æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹éš›ã¯ã€è‡ªå‹•è¨±å¯ãŒé©åˆ‡ã‹ã©ã†ã‹ã‚’æ…é‡ã«æ¤œè¨ã™ã‚‹ã“ã¨
- å¤–éƒ¨ MCP ãƒ„ãƒ¼ãƒ«ã¯çµ¶å¯¾ã«è‡ªå‹•è¨±å¯ãƒªã‚¹ãƒˆã«å«ã‚ãªã„

### ãƒªãƒã‚¸ãƒˆãƒªç™»éŒ²æ©Ÿèƒ½

ã‚ˆãä½¿ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚„ Git ãƒªãƒã‚¸ãƒˆãƒªã‚’äº‹å‰ç™»éŒ²ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«é¸æŠã§ãã‚‹æ©Ÿèƒ½ã€‚ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã¨ã€è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŒæ™‚ä¸¦è¡Œé–‹ç™ºãŒå¯èƒ½ã«ãªã‚‹ã€‚

#### ãƒªãƒã‚¸ãƒˆãƒªã‚¿ã‚¤ãƒ—

```
Repository Type
â”œâ”€â”€ local              # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆé Gitï¼‰
â”œâ”€â”€ local-git-worktree # ãƒ­ãƒ¼ã‚«ãƒ« Git ãƒªãƒã‚¸ãƒˆãƒªï¼ˆworktree ä½¿ç”¨ï¼‰
â””â”€â”€ remote-git         # ãƒªãƒ¢ãƒ¼ãƒˆ Git ãƒªãƒã‚¸ãƒˆãƒª
    â”œâ”€â”€ github         # GitHub (provider)
    â””â”€â”€ other          # ãã®ä»–ï¼ˆãƒ•ãƒ« URL æŒ‡å®šï¼‰
```

| ã‚¿ã‚¤ãƒ— | èª¬æ˜ | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®å‹•ä½œï¼ˆNativeï¼‰ | Container ãƒ¢ãƒ¼ãƒ‰ |
|--------|------|----------------------------------|------------------|
| `local` | ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | tmpfs ã«ã‚³ãƒ”ãƒ¼ | ãã®ã¾ã¾ä½¿ç”¨ï¼ˆCoWï¼‰ |
| `local-git-worktree` | ãƒ­ãƒ¼ã‚«ãƒ« Git ãƒªãƒã‚¸ãƒˆãƒª | `.worktree/agentdock-{sessionId}` ã« worktree ä½œæˆ | ãã®ã¾ã¾ä½¿ç”¨ï¼ˆCoWï¼‰ |
| `remote-git` | ãƒªãƒ¢ãƒ¼ãƒˆ Git ãƒªãƒã‚¸ãƒˆãƒª | cache ã« clone/fetch â†’ worktree ä½œæˆ | ãã®ã¾ã¾ä½¿ç”¨ï¼ˆCoWï¼‰ |

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
{serverRoot}/
â””â”€â”€ cache/                           # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (gitignore)
    â””â”€â”€ repos/                       # ãƒªãƒã‚¸ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
        â””â”€â”€ {repoId}/                # remote-git: ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰clone
            â””â”€â”€ .worktree/           # worktree ã¯ã“ã“ã«ä½œæˆ
                â””â”€â”€ agentdock-{sessionId}/

/tmp/agent-dock-repos/               # tmpfs ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆè¨­å®šå¯èƒ½ï¼‰
â””â”€â”€ {sessionId}/                     # local ã‚¿ã‚¤ãƒ—ã®ã‚³ãƒ”ãƒ¼å…ˆ
```

#### WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
| { type: 'list_repositories' }
| { type: 'create_repository'; name: string; path: string; repositoryType: RepositoryType; remoteUrl?: string; remoteBranch?: string }
| { type: 'update_repository'; id: string; name?: string; path?: string; repositoryType?: RepositoryType }
| { type: 'delete_repository'; id: string }

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
| { type: 'repository_list'; repositories: Repository[] }
| { type: 'repository_created'; repository: Repository }
| { type: 'repository_updated'; repository: Repository }
| { type: 'repository_deleted'; id: string }
```

#### create_session æ‹¡å¼µ

```typescript
interface CreateSessionMessage {
  type: 'create_session';
  name?: string;
  workingDir?: string;
  runnerBackend?: RunnerBackend;
  browserInContainer?: boolean;
  // ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ
  repositoryId?: string;      // workingDir ã®ä»£ã‚ã‚Šã«ãƒªãƒã‚¸ãƒˆãƒªã‚’æŒ‡å®š
  worktreeName?: string;      // Git ãƒªãƒã‚¸ãƒˆãƒªç”¨ã‚«ã‚¹ã‚¿ãƒ  worktree å
}
```

#### è¨­å®š

| è¨­å®š | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|------|-----------|------|
| `tmpfsBasePath` | `/tmp/agent-dock-repos/` | local ã‚¿ã‚¤ãƒ—ã®ã‚³ãƒ”ãƒ¼å…ˆ |
| `cacheDir` | `{serverRoot}/cache/` | remote-git ã® clone å…ˆ |

#### UI ãƒ•ãƒ­ãƒ¼

**ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ ï¼ˆ2æ®µéšã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼‰:**

```
Step 1: ã‚½ãƒ¼ã‚¹é¸æŠ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add Repository                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Where is your repository?       â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“ Local                  > â”‚ â”‚
â”‚ â”‚ Use a directory or git      â”‚ â”‚
â”‚ â”‚ repository on this machine  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ï¸ Remote                  > â”‚ â”‚
â”‚ â”‚ Clone from GitHub, GitLab,  â”‚ â”‚
â”‚ â”‚ or other git hosting        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2a: Local â†’ è©³ç´°å…¥åŠ›
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Local Repository              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Type:                           â”‚
â”‚ â—‹ Directory (tmpfs copy)        â”‚
â”‚ â— Git Repository (worktree)     â”‚
â”‚                                 â”‚
â”‚ Path: /home/user/project        â”‚
â”‚ Name: My Project                â”‚
â”‚                                 â”‚
â”‚              [Cancel] [Add]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2b: Remote â†’ è©³ç´°å…¥åŠ›
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Remote Repository             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Repository:                     â”‚
â”‚ [ğŸ™ GitHub] [ğŸŒ Other]          â”‚
â”‚ [owner/repo                   ] â”‚
â”‚ (ãƒ•ãƒ« URL ã‚‚è²¼ã‚Šä»˜ã‘å¯èƒ½)       â”‚
â”‚                                 â”‚
â”‚ Name: repo (auto-detected)      â”‚
â”‚ Branch: main (optional)         â”‚
â”‚                                 â”‚
â”‚              [Cancel] [Add]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**remote-git ã®å…¥åŠ›å½¢å¼:**
- `owner/repo` å½¢å¼ï¼ˆGitHub ãƒœã‚¿ãƒ³ã‚’é¸æŠï¼‰
- ãƒ•ãƒ« URL è²¼ã‚Šä»˜ã‘: `https://github.com/owner/repo.git` â†’ è‡ªå‹•ã§ GitHub æ¤œå‡º
- SSH URL: `git@github.com:owner/repo.git` â†’ è‡ªå‹•ã§ GitHub æ¤œå‡º
- ãã®ä»–ã® provider: `https://git.example.com/repo.git` â†’ "Other" ã¨ã—ã¦ä¿å­˜

#### Project é¸æŠï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ UIï¼‰

ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒWorking Directoryã€ã§ã¯ãªãã€Œ**Project**ã€ã‚’é¸æŠã™ã‚‹ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€å®Ÿéš›ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆworkingDirï¼‰ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è‡ªå‹•æ±ºå®šã•ã‚Œã‚‹ã€‚

**æ¦‚å¿µã®æ•´ç†:**
- **Project**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã™ã‚‹å¯¾è±¡ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã€æœ€è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹ï¼‰
- **Working Directory**: å®Ÿéš›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹å ´åˆã‚ã‚Šï¼‰

**SelectedProject å‹:**

```typescript
type SelectedProject =
  | { type: 'repository'; repositoryId: string }
  | { type: 'recent'; path: string; repositoryId?: string }
  | { type: 'custom'; path: string; useGitWorktree?: boolean };
```

**é¸æŠè‚¢:**

1. **ç™»éŒ²æ¸ˆã¿ãƒªãƒã‚¸ãƒˆãƒª** - Repositories ãƒšãƒ¼ã‚¸ã§äº‹å‰ç™»éŒ²ã—ãŸãƒªãƒã‚¸ãƒˆãƒª
2. **Recent Project** - æœ€è¿‘ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ä½¿ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
   - repositoryId ãŒã‚ã‚‹å ´åˆ: ãƒªãƒã‚¸ãƒˆãƒªåã‚’è¡¨ç¤º
   - repositoryId ãŒãªã„å ´åˆ: workingDir ã‚’è¡¨ç¤º
3. **ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹** - ç›´æ¥å…¥åŠ›
   - Git ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ: local vs local-git-worktree ã‚’é¸æŠå¯èƒ½
   - é Git ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ: ãã®ã¾ã¾ä½¿ç”¨

**ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹ã§ã® Git åˆ¤å®š:**
- ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‘ã‚¹ãŒ Git ãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ã‚’æ¤œè¨¼
- Git ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã€UI ã§ã€ŒUse git worktreeã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
- é¸æŠã«å¿œã˜ã¦ localï¼ˆtmpfs ã‚³ãƒ”ãƒ¼ï¼‰ã‹ local-git-worktreeï¼ˆworktree ä½œæˆï¼‰ã«åˆ†å²

**UI ãƒ•ãƒ­ãƒ¼ (InputArea session-start mode):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Project: â–¼ Select project...              ]    â”‚
â”‚                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ REPOSITORIES                                â”‚ â”‚
â”‚ â”‚   ğŸ“ my-project (Local)                     â”‚ â”‚
â”‚ â”‚   ğŸ”€ claude-bridge (Git Worktree)           â”‚ â”‚
â”‚ â”‚   â˜ï¸ anthropics/claude-code (Remote)        â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ RECENT                                      â”‚ â”‚
â”‚ â”‚   ğŸ“ ~/work/other-project                   â”‚ â”‚
â”‚ â”‚   ğŸ”€ my-project (from repo)                 â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚   âœï¸ Custom path...                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹å…¥åŠ›æ™‚ï¼ˆGit ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Path: /home/user/my-git-repo                    â”‚
â”‚                                                 â”‚
â”‚ âš ï¸ Git repository detected                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â—‹ Copy to tmpfs (isolated, slower)          â”‚ â”‚
â”‚ â”‚ â— Use git worktree (parallel development)   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**RecentProject å‹:**

```typescript
interface RecentProject {
  path: string;              // workingDir
  repositoryId?: string;     // ç´ã¥ããƒªãƒã‚¸ãƒˆãƒªï¼ˆã‚ã‚Œã°ï¼‰
  repositoryName?: string;   // ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆè¡¨ç¤ºç”¨ï¼‰
  lastUsed: string;          // æœ€çµ‚ä½¿ç”¨æ—¥æ™‚
}
```

Recent Project ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã•ã‚Œã‚‹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ï¼‰ã€‚
