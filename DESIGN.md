# Claude Bridge - è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## æ¦‚è¦

Claude Bridge ã¯ã€Claude Code CLI ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒƒãƒ UI ã‹ã‚‰æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚å˜ãªã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€**plan ãƒ¢ãƒ¼ãƒ‰ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€é¸æŠè‚¢ã€å·®åˆ†ææ¡ˆãªã©ã‚’å°‚ç”¨ UI ã§è¡¨ç¤º**ã—ã¾ã™ã€‚

## è¦ä»¶

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript + shadcn/ui
- **èªè¨¼**: ä¸è¦ï¼ˆè‡ªåˆ†å°‚ç”¨ï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–**: å¿…è¦ï¼ˆClaude Code ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
- **ãƒªãƒƒãƒUI**: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›ã ã‘ã§ãªãã€æ§‹é€ åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€è³ªå•ã€å·®åˆ†ï¼‰ã‚’å°‚ç”¨ UI ã§è¡¨ç¤º
- **Claude Max äº’æ›**: å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸæ–¹æ³•ã®ã¿ä½¿ç”¨

## èƒŒæ™¯çŸ¥è­˜

### Claude Code CLI Headless Mode

Claude Max ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§å…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸæ–¹æ³•ã€‚

```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
claude -p "prompt" --output-format stream-json

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
claude -p "follow-up" --continue
claude -p "specific session" --resume <session_id>

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ MCP ãƒ„ãƒ¼ãƒ«ã«å§”è­²
claude -p "prompt" --permission-prompt-tool mcp__bridge__permission_prompt
```

### --permission-prompt-tool ã‚ªãƒ—ã‚·ãƒ§ãƒ³

ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ MCP ãƒ„ãƒ¼ãƒ«ã«å§”è­²ã™ã‚‹å…¬å¼æ©Ÿèƒ½ã€‚

**å‹•ä½œãƒ¡ã‚«ãƒ‹ã‚ºãƒ ** (3å±¤ãƒã‚§ãƒƒã‚¯):
1. `--allowedTools` / `--disallowedTools` ã§äº‹å‰å®šç¾©ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
2. ãƒ«ãƒ¼ãƒ«ãŒãƒãƒƒãƒã™ã‚Œã°å³åº§ã«è¨±å¯/æ‹’å¦
3. ãƒ«ãƒ¼ãƒ«ãªã—ãªã‚‰ MCP ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—

**MCP ãƒ„ãƒ¼ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
```json
// è¨±å¯
{"behavior": "allow", "updatedInput": {...}}

// æ‹’å¦
{"behavior": "deny", "message": "ç†ç”±"}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ `~/.claude/sessions/` ã«è‡ªå‹•ä¿å­˜
- `--resume <session_id>` ã§ç‰¹å®šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹
- `--continue` ã§æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
- stream-json å‡ºåŠ›ã« `session_id` ãŒå«ã¾ã‚Œã‚‹

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Server (Node.js)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Hono + WebSocket                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚              Session Manager                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Session #1   â”‚  â”‚   Session #2   â”‚  ...     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚claude CLI  â”‚ â”‚  â”‚ â”‚claude CLI  â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚(subprocess)â”‚ â”‚  â”‚ â”‚(subprocess)â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â”‚stream-json â”‚ â”‚  â”‚ â”‚stream-json â”‚ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚           MCP Server (Permission Handler)         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    mcp__bridge__permission_prompt â—„â”€â”€â–º WebSocket  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ WebSocket
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Sidebar    â”‚  â”‚            Main Area                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚Session1â”‚  â”‚  â”‚  â”‚      Message Stream            â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚Session2â”‚  â”‚  â”‚  â”‚  â”‚ [Text Output]            â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  [+]   â”‚  â”‚  â”‚  â”‚  â”‚ [Permission Request UI]  â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â”‚  Allow / Deny / Modify   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚ [AskUserQuestion UI]     â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚  Option 1 / Option 2...  â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚ [Diff View UI]           â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â”‚  Accept / Reject         â”‚  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â”‚        Input Area              â”‚  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ WebSocket â†’ ã‚µãƒ¼ãƒãƒ¼
   - ã‚µãƒ¼ãƒãƒ¼: `claude -p "prompt" --resume <session_id> --output-format stream-json --permission-prompt-tool mcp__bridge__permission_prompt`

2. **Claude å‡ºåŠ›**
   - claude CLI (stream-json) â†’ ã‚µãƒ¼ãƒãƒ¼ã§ãƒ‘ãƒ¼ã‚¹ â†’ WebSocket â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI

3. **ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚**
   - claude CLI â†’ MCP Server (permission_prompt ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—)
   - MCP Server â†’ WebSocket â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­” â†’ WebSocket â†’ MCP Server â†’ allow/deny ã‚’è¿”ã™
   - claude CLI ãŒå‡¦ç†ã‚’ç¶™ç¶š

4. **AskUserQuestion**
   - AskUserQuestion ã¯ `--allowedTools` ã«å«ã‚ã‚‹ã“ã¨ã§è‡ªå‹•è¨±å¯
   - ã¾ãŸã¯ MCP Server ã§ç‰¹åˆ¥å‡¦ç†ã—ã¦ WebSocket ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è»¢é€

---

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
claude-bridge/
â”œâ”€â”€ package.json              # Monorepo root
â”œâ”€â”€ pnpm-workspace.yaml       # pnpm workspaces è¨­å®š
â”œâ”€â”€ mcp-config.json           # MCP ã‚µãƒ¼ãƒãƒ¼è¨­å®š
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ server/               # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts     # Hono + WebSocket
â”‚   â”‚   â”‚   â”œâ”€â”€ session-manager.ts  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ claude-runner.ts    # claude CLI å®Ÿè¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ runner-manager.ts   # Runner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ stream-parser.ts    # stream-json ãƒ‘ãƒ¼ã‚µãƒ¼
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp-server/           # MCP ã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # MCP ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â””â”€â”€ permission-handler.ts  # permission_prompt ãƒ„ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ client/               # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SessionTab.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageStream.tsx     # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PermissionRequest.tsx # ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ UI
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AskUserQuestion.tsx   # è³ªå• UI
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DiffView.tsx          # å·®åˆ†è¡¨ç¤º
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ InputArea.tsx         # å…¥åŠ›ã‚¨ãƒªã‚¢
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useSession.ts
â”‚   â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ vite.config.ts
â”‚   â”‚
â”‚   â””â”€â”€ shared/               # å…±æœ‰å‹å®šç¾©
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â””â”€â”€ index.ts      # WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ DESIGN.md                 # ã“ã®è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â””â”€â”€ README.md
```

---

## æŠ€è¡“é¸å®š

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Node.js | 22.x / 24.x |
| è¨€èª | TypeScript | 5.9.x |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | React | 19.2.x |
| UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | shadcn/ui | (Tailwind v4å¯¾å¿œ) |
| CSS | Tailwind CSS | 4.x |
| å·®åˆ†è¡¨ç¤º | react-diff-viewer-continued | 3.4.x |
| é€šä¿¡ | ws | 8.18.x |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Hono | 4.11.x |
| Claude å®Ÿè¡Œ | `claude` CLI | (subprocess, stream-json) |
| MCP Server | @modelcontextprotocol/sdk | 1.12.x |
| ãƒ“ãƒ«ãƒ‰ (client) | Vite | 7.x |
| ãƒ“ãƒ«ãƒ‰ (server) | tsc | - |
| ãƒ¢ãƒãƒ¬ãƒ | pnpm workspaces | - |
| ãƒ†ã‚¹ãƒˆ | vitest | 3.x |

---

## WebSocket ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
type ClientMessage =
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  | { type: 'create_session'; name?: string; workingDir?: string }
  | { type: 'attach_session'; sessionId: string }
  | { type: 'detach_session'; sessionId: string }
  | { type: 'delete_session'; sessionId: string }
  | { type: 'rename_session'; sessionId: string; name: string }
  | { type: 'list_sessions' }
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
  | { type: 'user_message'; sessionId: string; content: string }
  | { type: 'interrupt'; sessionId: string }
  // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å¿œç­”
  | { type: 'permission_response'; sessionId: string; requestId: string;
      response: { behavior: 'allow'; updatedInput: any } | { behavior: 'deny'; message: string } }
  // AskUserQuestion å¿œç­”
  | { type: 'question_response'; sessionId: string; requestId: string;
      answers: Record<string, string> };

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
type ServerMessage =
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  | { type: 'session_created'; session: SessionInfo }
  | { type: 'session_attached'; sessionId: string; history: MessageItem[] }
  | { type: 'session_list'; sessions: SessionInfo[] }
  | { type: 'session_deleted'; sessionId: string }
  // Agent å‡ºåŠ›
  | { type: 'text_output'; sessionId: string; text: string }
  | { type: 'tool_use'; sessionId: string; toolName: string; toolUseId: string; input: any }
  | { type: 'tool_result'; sessionId: string; toolUseId: string; content: string; isError?: boolean }
  | { type: 'result'; sessionId: string; result: string }
  // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  | { type: 'permission_request'; sessionId: string; requestId: string;
      toolName: string; input: any }
  // AskUserQuestion
  | { type: 'ask_user_question'; sessionId: string; requestId: string;
      questions: Array<{ question: string; header: string;
                         options: Array<{ label: string; description: string }>;
                         multiSelect: boolean }> }
  // ã‚¨ãƒ©ãƒ¼
  | { type: 'error'; sessionId?: string; message: string };
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±

```typescript
interface SessionInfo {
  id: string;              // Bridge ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID
  name: string;            // è¡¨ç¤ºå
  createdAt: string;       // ä½œæˆæ—¥æ™‚
  workingDir: string;      // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  status: SessionStatus;   // çŠ¶æ…‹
  claudeSessionId?: string; // Claude CLI ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID (--resume ç”¨)
}

type SessionStatus = 'running' | 'waiting_input' | 'waiting_permission' | 'idle';
```

---

## ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### ClaudeRunner (packages/server/src/claude-runner.ts)

Claude CLI ã‚’ subprocess ã¨ã—ã¦å®Ÿè¡Œã—ã€stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- `claude` CLI ã®èµ·å‹• (`spawn`)
- stream-json (NDJSON) å‡ºåŠ›ã®ãƒ‘ãƒ¼ã‚¹
- ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œ (`text`, `tool_use`, `tool_result`, `result`, `system`, `error`, `exit`)

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³:**
- `workingDir`: ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- `claudePath`: claude ã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ã‚¹
- `mcpConfigPath`: MCP è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
- `permissionToolName`: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«å

### RunnerManager (packages/server/src/runner-manager.ts)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã® ClaudeRunner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- ClaudeRunner ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã¨ Runner ã®ç´ä»˜ã‘
- ã‚¤ãƒ™ãƒ³ãƒˆã®è»¢é€

### SessionManager (packages/server/src/session-manager.ts)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

**è²¬å‹™:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ/å‰Šé™¤/æ›´æ–°
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®ä¿æŒ
- Claude ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ç´ä»˜ã‘

### StreamJsonParser (packages/server/src/stream-parser.ts)

Claude CLI ã® stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€‚

**å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ:**
- `assistant`: ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã€ãƒ„ãƒ¼ãƒ«ä½¿ç”¨
- `user`: ãƒ„ãƒ¼ãƒ«çµæœ
- `result`: å‡¦ç†å®Œäº†
- `system`: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

---

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºç›¤ âœ…
1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–** âœ…
   - pnpm workspaces ã§ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ
   - TypeScript è¨­å®š
   - shared ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å‹å®šç¾©ã‚’å…±æœ‰

2. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤** âœ…
   - Hono ã‚µãƒ¼ãƒãƒ¼
   - WebSocket ã‚µãƒ¼ãƒãƒ¼ (ws)
   - åŸºæœ¬çš„ãªæ¥ç¶šç¢ºèª

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤** âœ…
   - Vite + React + TypeScript
   - WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (useWebSocket hook)

### Phase 2: Claude CLI çµ±åˆ ğŸš§
4. **Claude CLI å®Ÿè¡ŒåŸºç›¤** âœ…
   - child_process ã§ claude CLI ã‚’å®Ÿè¡Œ
   - stream-json å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹
   - NDJSON ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†

5. **MCP Server å®Ÿè£…** ğŸš§
   - @modelcontextprotocol/sdk ã§ã‚µãƒ¼ãƒãƒ¼ä½œæˆ
   - `permission_prompt` ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…
   - WebSocket ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨é€šä¿¡

6. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** â³
   - MessageStream: ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›è¡¨ç¤º
   - PermissionRequest: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨±å¯ UI
   - InputArea: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›

### Phase 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† â³
7. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - `--resume <session_id>` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®ä¿æŒ

8. **ã‚µã‚¤ãƒ‰ãƒãƒ¼ UI**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ/å‰Šé™¤/åå‰å¤‰æ›´

### Phase 4: ä»•ä¸Šã’ â³
9. **AskUserQuestion UI**
   - Claude ã‹ã‚‰ã®è³ªå•ã‚’é¸æŠè‚¢ UI ã§è¡¨ç¤º

10. **å·®åˆ†è¡¨ç¤º UI**
    - Write/Edit ãƒ„ãƒ¼ãƒ«ã®å·®åˆ†ã‚’ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
    - react-diff-viewer-continued ã§å®Ÿè£…

11. **UXæ”¹å–„**
    - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    - ä¸­æ–­æ©Ÿèƒ½ï¼ˆSIGINT é€ä¿¡ï¼‰

---

## æ¤œè¨¼æ–¹æ³•

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd packages/server && pnpm dev

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
cd packages/client && pnpm dev
```

http://localhost:5173 ã§ã‚¢ã‚¯ã‚»ã‚¹

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
pnpm -r test

# ç‰¹å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
cd packages/server && pnpm test
```

### å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒã§ãã‚‹
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹
- [ ] Claude ã‹ã‚‰ã®å¿œç­”ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆstream-jsonï¼‰
- [ ] ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ UI ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆMCP çµŒç”±ï¼‰
- [ ] ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨±å¯/æ‹’å¦ã§ãã‚‹
- [ ] AskUserQuestion ãŒé¸æŠè‚¢ UI ã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é¸æŠå¾Œã« Claude ãŒå‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹
- [ ] è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ï¼ˆ--resumeï¼‰
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦å†æ¥ç¶šã—ã¦ã‚‚å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## æ³¨æ„äº‹é …

### MCP Server ã®åˆ¶ç´„

- MCP ãƒ„ãƒ¼ãƒ«ã¯ **åŒæœŸçš„ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™å¿…è¦ãŒãªã„**ï¼ˆPromise ã‚’è¿”ã›ã‚‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å¾…æ©Ÿã™ã‚‹é–“ã€Promise ã‚’ resolve ã›ãšã«å¾…æ©Ÿå¯èƒ½
- ãŸã ã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰ã«æ³¨æ„

### stream-json å‡ºåŠ›å½¢å¼

- NDJSON (Newline Delimited JSON) å½¢å¼
- å„è¡ŒãŒç‹¬ç«‹ã—ãŸ JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `type` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥ã‚’åˆ¤åˆ¥

### Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ°¸ç¶šæ€§

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ `~/.claude/sessions/` ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹
- `--resume <session_id>` ã§å†é–‹å¯èƒ½
- ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã®ã¿ç®¡ç†

### Claude Max ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

- `ANTHROPIC_API_KEY` ç’°å¢ƒå¤‰æ•°ãŒ **è¨­å®šã•ã‚Œã¦ã„ãªã„** ã“ã¨ã‚’ç¢ºèª
- Claude Max subscription ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- Anthropic ãŒå…¬å¼ã«è¨±å¯ã—ã¦ã„ã‚‹æ–¹æ³•ã®ã¿ä½¿ç”¨
